<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç–¯ç‹‚çš„å·ç‹ï¼ˆä½œè€…ï¼šåˆ«å†æµ®å¤¸äº†ç¾¤å°ç»„ï¼‰</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            background-color: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: #ddd;
            border-radius: 5px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #ddd;
        }
        .tab.active {
            background-color: #333;
            color: #fff;
        }
        .content {
            display: none;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .content.active {
            display: block;
        }
        .stat-box {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-item {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            text-align: center;
        }
        .btn {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-danger {
            background-color: #f44336;
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        .btn-warning {
            background-color: #ff9800;
        }
        .btn-warning:hover {
            background-color: #e65100;
        }
        .btn-primary {
            background-color: #2196F3;
        }
        .btn-primary:hover {
            background-color: #1976D2;
        }
        .btn-secondary {
            background-color: #9E9E9E;
        }
        .btn-secondary:hover {
            background-color: #757575;
        }
        .btn-success {
            background-color: #4CAF50;
        }
        .btn-success:hover {
            background-color: #388E3C;
        }
        .btn-info {
            background-color: #03A9F4;
        }
        .btn-info:hover {
            background-color: #0288D1;
        }
        .btn-dark {
            background-color: #333;
        }
        .btn-dark:hover {
            background-color: #111;
        }
        .btn-outline {
            background-color: transparent;
            border: 1px solid #333;
            color: black;
        }
        .btn-outline:hover {
            background-color: #333;
            color: white;
        }
        .quality {
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            display: inline-block;
        }
        .quality-common {
            background-color: #fff;
            color: #000;
            border: 1px solid #ccc;
        }
        .quality-uncommon {
            background-color: #4CAF50;
        }
        .quality-rare {
            background-color: #2196F3;
        }
        .quality-epic {
            background-color: #9C27B0;
        }
        .quality-legendary {
            background-color: #FFC107;
        }
        .quality-mythic {
            background-color: #FF5722;
        }
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .equipment-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            position: relative;
        }
        .equipment-item.locked {
            background-color: #f5f5f5;
        }
        .equipment-item.locked::after {
            content: "ğŸ”’";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
        }
        .equipment-item.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        .equipment-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .equipment-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .equipment-attrs {
            font-size: 12px;
            color: #666;
        }
        .equipment-attr {
            margin-bottom: 3px;
        }
        .equipment-slot {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .slot {
            border: 1px dashed #ccc;
            border-radius: 5px;
            padding: 10px;
            min-height: 100px;
            position: relative;
            cursor: pointer;
        }
        .slot-name {
            position: absolute;
            top: -10px;
            left: 10px;
            background-color: #333;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        .slot-empty {
            color: #999;
            text-align: center;
            /* line-height: 80px; */
        }
        .battle-log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .map-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .map-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #f5f5f5;
        }
        .map-item.locked {
            background-color: #eee;
            color: #999;
        }
        .map-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .map-info {
            font-size: 12px;
            color: #666;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            max-width: 500px;
            width: 80%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        .modal-close {
            cursor: pointer;
            font-size: 20px;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .auto-sell-settings {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .auto-sell-settings h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .auto-sell-settings select, .auto-sell-settings input {
            margin-right: 10px;
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        .auto-sell-settings button {
            margin-top: 10px;
        }
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .shop-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        .shop-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .shop-item-price {
            color: #ff9800;
            margin-bottom: 10px;
        }
        .progress-bar {
            height: 20px;
            background-color: #f5f5f5;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        .awakening-points {
            background-color: #ff9800;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
        /* èƒŒåŒ…ç•Œé¢æŒ‰é’®æ ·å¼ */
        .btn-wear, .btn-lock, .btn-sell, .btn-unequip {
            color: black; /* è®¾ç½®å­—ä½“é¢œè‰²ä¸ºé»‘è‰² */
        }
        /* è£…å¤‡ç•Œé¢è„±ä¸‹æŒ‰é’®å­—ä½“é¢œè‰² */
        .btn-remove-equipment {
            color: black; /* è®¾ç½®å­—ä½“é¢œè‰²ä¸ºé»‘è‰² */
        }
        /* è£…å¤‡é€‰æ‹©å¼¹çª— */
        .equipment-selection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .equipment-selection-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            max-width: 600px; /* è®¾ç½®æœ€å¤§å®½åº¦ */
            width: 80%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-height: 80vh; /* è®¾ç½®æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„80% */
            overflow-y: auto; /* å¯ç”¨å‚ç›´æ»šåŠ¨ */
        }
        .equipment-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .equipment-selection-title {
            font-size: 18px;
            font-weight: bold;
        }
        .equipment-selection-close {
            cursor: pointer;
            font-size: 20px;
        }
        .equipment-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .equipment-selection-footer {
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <script src="chs.js"></script>
    <script src="core.js"></script>
    <div class="container">
        <div class="header">
            <h1>ç–¯ç‹‚çš„å·ç‹ï¼ˆä½œè€…ï¼šåˆ«å†æµ®å¤¸äº†ç¾¤å°ç»„ï¼‰</h1>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="character">è§’è‰²</div>
            <div class="tab" data-tab="equipment">è£…å¤‡</div>
            <div class="tab" data-tab="inventory">èƒŒåŒ…</div>
            <div class="tab" data-tab="blacksmith">é“åŒ é“º</div>
            <div class="tab" data-tab="crystal-shop">æ°´æ™¶å•†åº—</div>
            <div class="tab" data-tab="maps">åœ°å›¾</div>
        </div>
        
        <div id="character" class="content active">
            <h2>è§’è‰²å±æ€§</h2>
            <div class="stat-box">
                <div class="stat-item">
                    <div>ç­‰çº§: <span id="character-level">1</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="exp-progress"></div>
                    </div>
                    <div class="progress-text">
                        <span id="current-exp">0</span>/<span id="required-exp">100</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div>ç”Ÿå‘½å€¼: <span id="character-hp">30</span></div>
                    <div>é­”æ³•å€¼: <span id="character-mp">30</span></div>
                    <div>æ”»å‡»åŠ›: <span id="character-attack">5</span></div>
                    <div>é˜²å¾¡åŠ›: <span id="character-defense">5</span></div>
                </div>
                <div class="stat-item">
                    <div>é‡‘å¸: <span id="character-gold">0</span></div>
                    <div>æ°´æ™¶: <span id="character-crystal">0</span></div>
                </div>
                <div class="stat-item">
                    <div>æš´å‡»ç‡: <span id="character-crit-rate">0%</span></div>
                    <div>æš´å‡»ä¼¤å®³: <span id="character-crit-damage">0%</span></div>
                    <div>æ”»å‡»åŠ›åŠ æˆ: <span id="character-attack-bonus">0%</span></div>
                    <div>é˜²å¾¡åŠ›åŠ æˆ: <span id="character-defense-bonus">0%</span></div>
                </div>
            </div>
            
            <div class="bonus-attributes">
                <h3>é™„åŠ å±æ€§</h3>
                <div class="bonus-attribute">
                    <div>ç»éªŒæ‰è½åŠ æˆ: <span id="exp-bonus">0%</span></div>
                </div>
                <div class="bonus-attribute">
                    <div>é‡‘å¸æ‰è½åŠ æˆ: <span id="gold-bonus">0%</span></div>
                </div>
                <div class="bonus-attribute">
                    <div>æ°´æ™¶æ‰è½åŠ æˆ: <span id="crystal-bonus">0%</span></div>
                </div>
            </div>
            
            <h3>æˆ˜æ–—ä¿¡æ¯</h3>
            <div class="battle-log" id="battle-log">
                <div class="log-entry">æ¬¢è¿æ¥åˆ°ç–¯ç‹‚çš„å·ç‹æ¸¸æˆï¼</div>
                <div class="log-entry">è¯·é€‰æ‹©åœ°å›¾å¼€å§‹å†’é™©ï¼</div>
            </div>
            
            <!-- æš‚åœæˆ˜æ–—æŒ‰é’® -->
            <button class="btn btn-danger" id="pause-battle" style="margin-top: 10px;">æš‚åœæˆ˜æ–—</button>
        </div>
        
        <div id="equipment" class="content">
            <h2>è£…å¤‡ç³»ç»Ÿ</h2>
            <div class="equipment-slot">
                <div class="slot" data-slot="weapon-main">
                    <div class="slot-name">ä¸»æ‰‹æ­¦å™¨</div>
                    <div class="slot-content" id="weapon-main-content">ç©º</div>
                </div>
                <div class="slot" data-slot="weapon-off">
                    <div class="slot-name">å‰¯æ‰‹æ­¦å™¨</div>
                    <div class="slot-content" id="weapon-off-content">ç©º</div>
                </div>
                <div class="slot" data-slot="helmet">
                    <div class="slot-name">å¤´ç›”</div>
                    <div class="slot-content" id="helmet-content">ç©º</div>
                </div>
                <div class="slot" data-slot="armor">
                    <div class="slot-name">æŠ¤ç”²</div>
                    <div class="slot-content" id="armor-content">ç©º</div>
                </div>
                <div class="slot" data-slot="gloves">
                    <div class="slot-name">æ‰‹å¥—</div>
                    <div class="slot-content" id="gloves-content">ç©º</div>
                </div>
                <div class="slot" data-slot="boots">
                    <div class="slot-name">é‹å­</div>
                    <div class="slot-content" id="boots-content">ç©º</div>
                </div>
                <div class="slot" data-slot="legs">
                    <div class="slot-name">æŠ¤è…¿</div>
                    <div class="slot-content" id="legs-content">ç©º</div>
                </div>
                <div class="slot" data-slot="necklace">
                    <div class="slot-name">é¡¹é“¾</div>
                    <div class="slot-content" id="necklace-content">ç©º</div>
                </div>
                <div class="slot" data-slot="ring-left">
                    <div class="slot-name">å·¦æˆ’æŒ‡</div>
                    <div class="slot-content" id="ring-left-content">ç©º</div>
                </div>
                <div class="slot" data-slot="ring-right">
                    <div class="slot-name">å³æˆ’æŒ‡</div>
                    <div class="slot-content" id="ring-right-content">ç©º</div>
                </div>
                <div class="slot" data-slot="amulet">
                    <div class="slot-name">æŠ¤ç¬¦</div>
                    <div class="slot-content" id="amulet-content">ç©º</div>
                </div>
                <div class="slot" data-slot="badge">
                    <div class="slot-name">å¾½ç« </div>
                    <div class="slot-content" id="badge-content">ç©º</div>
                </div>
                <div class="slot" data-slot="artefact">
                    <div class="slot-name">æ³•å™¨</div>
                    <div class="slot-content" id="artefact-content">ç©º</div>
                </div>
            </div>
        </div>
        
        <div id="inventory" class="content">
            <h2>èƒŒåŒ…ç³»ç»Ÿ</h2>
            <div class="equipment-grid" id="inventory-grid">
                <!-- èƒŒåŒ…å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="auto-sell-settings">
                <h3>è‡ªåŠ¨å”®å–è®¾ç½®</h3>
                <div>
                    <label>å“è´¨ä½äºç­‰äº:</label>
                    <select id="auto-sell-quality">
                        <option value="common">æ™®é€š</option>
                        <option value="uncommon">ç²¾è‰¯</option>
                        <option value="rare" selected>ç¨€æœ‰</option>
                        <option value="epic">å²è¯—</option>
                        <option value="legendary">ä¼ è¯´</option>
                        <option value="mythic">ç¥è¯</option>
                    </select>
                    <label>ç­‰çº§ä½äº:</label>
                    <input type="number" id="auto-sell-level" value="10" min="1">
                    <button class="btn btn-secondary" id="save-auto-sell-settings">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
            
            <button class="btn btn-danger" id="sell-all-btn">ä¸€é”®å”®å–æ‰€æœ‰è£…å¤‡</button>
        </div>
        
        <div id="blacksmith" class="content">
            <h2>é“åŒ é“º</h2>
            <div id="equipment-selection">
                <h3>é€‰æ‹©è¦å¼ºåŒ–æˆ–è¿›åŒ–çš„è£…å¤‡</h3>
                <div id="worn-equipment-list">
                    <!-- ç©¿æˆ´çš„è£…å¤‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <div id="reinforce-panel" style="display: none; margin-top: 20px;">
                <h3>è£…å¤‡å¼ºåŒ–</h3>
                <p>æ¶ˆè€—é‡‘å¸å¼ºåŒ–è£…å¤‡ï¼Œæœ€é«˜å¼ºåŒ–+200ï¼Œæ¯+1è£…å¤‡å±æ€§æé«˜0.1%ï¼Œå¼ºåŒ–æˆåŠŸç‡ä¸º10%</p>
                <div>
                    <label>å½“å‰å¼ºåŒ–ç­‰çº§: <span id="current-reinforce">0</span></label>
                    <label>éœ€è¦é‡‘å¸: <span id="reinforce-cost">0</span></label>
                </div>
                <button class="btn btn-primary" id="do-reinforce">å¼ºåŒ–</button>
            </div>
            
            <div id="evolve-panel" style="display: none; margin-top: 20px;">
                <h3>è£…å¤‡è¿›åŒ–</h3>
                <p>æ¶ˆè€—æå‡å·è½´æé«˜è£…å¤‡å±æ€§ï¼Œæ¯çº§æé«˜è£…å¤‡å„é¡¹å±æ€§0.5%ï¼ŒæˆåŠŸç‡ä¸º10%ï¼Œæœ€é«˜æå‡ç­‰çº§ä¸º+200</p>
                <div>
                    <label>å½“å‰è¿›åŒ–ç­‰çº§: <span id="current-evolve">0</span></label>
                    <label>éœ€è¦å·è½´: <span id="evolve-cost">0</span></label>
                </div>
                <button class="btn btn-info" id="do-evolve">è¿›åŒ–</button>
            </div>
        </div>
        
        <div id="crystal-shop" class="content">
            <h2>æ°´æ™¶å•†åº—</h2>
            <div class="shop-items">
                <div class="shop-item">
                    <div class="shop-item-name">æå‡å·è½´</div>
                    <div class="shop-item-price">10æ°´æ™¶</div>
                    <button class="btn" id="buy-evolve-scroll">è´­ä¹°</button>
                </div>
            </div>
        </div>
        
        <div id="maps" class="content">
            <h2>åœ°å›¾é€‰æ‹©</h2>
            <h3>æ™®é€šåœ°å›¾</h3>
            <div class="map-list" id="normal-maps">
                <!-- æ™®é€šåœ°å›¾å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <h3>ç§˜å¢ƒåœ°å›¾</h3>
            <div class="map-list" id="secret-maps">
                <!-- ç§˜å¢ƒåœ°å›¾å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- å¼ºåŒ–/è¿›åŒ–ç»“æœå¼¹çª— -->
        <div id="result-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">æ“ä½œç»“æœ</span>
                    <span class="modal-close">&times;</span>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- å¼¹çª—å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="modal-footer">
                    <button class="btn" id="modal-close-btn">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- è§‰é†’å¼¹çª— -->
        <div id="awakening-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">è§’è‰²è§‰é†’</span>
                    <span class="modal-close">&times;</span>
                </div>
                <div class="modal-body">
                    <p>æ­å–œä½ è¾¾åˆ°200çº§ï¼ä½ çš„è§’è‰²å·²ç»è§‰é†’ï¼</p>
                    <p>ç­‰çº§å·²é‡ç½®ä¸º1ï¼Œè·å¾—100è§‰é†’ç‚¹</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="awakening-confirm-btn">ç¡®è®¤</button>
                </div>
            </div>
        </div>
        
        <!-- æˆ˜æ–—ä¸­æ“ä½œæç¤ºå¼¹çª— -->
        <div id="battle-operation-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">æç¤º</span>
                    <span class="modal-close">&times;</span>
                </div>
                <div class="modal-body">
                    <p>è¯·å…ˆæš‚åœæˆ˜æ–—å†è¿›è¡Œæ­¤æ“ä½œã€‚</p>
                </div>
                <div class="modal-footer">
                    <button class="btn" id="battle-operation-close-btn">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- è£…å¤‡é€‰æ‹©å¼¹çª— -->
        <div id="equipment-selection-modal" class="equipment-selection-modal">
            <div class="equipment-selection-content">
                <div class="equipment-selection-header">
                    <span class="equipment-selection-title">é€‰æ‹©è£…å¤‡</span>
                    <span class="equipment-selection-close" id="equipment-selection-close"></span>&times;</span>
                </div>
                <div class="equipment-selection-grid" id="equipment-selection-grid">
                    <!-- è£…å¤‡é€‰æ‹©å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="equipment-selection-footer">
                    <button class="btn btn-outline" id="equipment-selection-cancel">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®å­˜å‚¨
        const gameData = {
            character: {
                level: 1,
                exp: 0,
                maxExp: 100,
                awakeningPoints: 0,
                awakeningLevel: 0,
                derivedStats: {
                    attack: 5,
                    defense: 5,
                    hp: 30,
                    mp: 30,
                    expBonus: 0,
                    goldBonus: 0,
                    crystalBonus: 0,
                    critRate: 0,
                    critDamage: 0,
                    attackBonus: 0,
                    defenseBonus: 0
                },
                gold: 0,
                crystal: 0
            },
            equipment: {
                slots: {
                    'weapon-main': null,
                    'weapon-off': null,
                    'helmet': null,
                    'armor': null,
                    'gloves': null,
                    'boots': null,
                    'legs': null,
                    'necklace': null,
                    'ring-left': null,
                    'ring-right': null,
                    'amulet': null,
                    'badge': null,
                    'artefact': null
                },
                inventory: []
            },
            maps: {
                normal: [
                    { 
                        id: 0, 
                        name: "å©´å„¿å·ç‹", 
                        minLevel: 1, 
                        maxLevel: 3, 
                        bossLevel: 3, 
                        minEquipLevel: 1, 
                        maxEquipLevel: 4, 
                        requiredPlayerLevel: 1 
                    },
                    { 
                        id: 1, 
                        name: "å¹¼å„¿å›­å·ç‹", 
                        minLevel: 1, 
                        maxLevel: 10, 
                        bossLevel: 10, 
                        minEquipLevel: 1, 
                        maxEquipLevel: 10, 
                        requiredPlayerLevel: 1 
                    },
                    { 
                        id: 2, 
                        name: "å°å­¦å·ç‹", 
                        minLevel: 11, 
                        maxLevel: 20, 
                        bossLevel: 20, 
                        minEquipLevel: 11, 
                        maxEquipLevel: 20, 
                        requiredPlayerLevel: 11 
                    },
                    { 
                        id: 3, 
                        name: "åˆä¸­å·ç‹", 
                        minLevel: 21, 
                        maxLevel: 30, 
                        bossLevel: 30, 
                        minEquipLevel: 21, 
                        maxEquipLevel: 30, 
                        requiredPlayerLevel: 21 
                    },
                    { 
                        id: 4, 
                        name: "é«˜ä¸­å·ç‹", 
                        minLevel: 31, 
                        maxLevel: 40, 
                        bossLevel: 40, 
                        minEquipLevel: 31, 
                        maxEquipLevel: 40, 
                        requiredPlayerLevel: 31 
                    },
                    { 
                        id: 5, 
                        name: "å¤§å­¦å·ç‹", 
                        minLevel: 41, 
                        maxLevel: 50, 
                        bossLevel: 50, 
                        minEquipLevel: 41, 
                        maxEquipLevel: 50, 
                        requiredPlayerLevel: 41 
                    },
                    { 
                        id: 6, 
                        name: "å·¥ç¨‹éƒ¨å·ç‹", 
                        minLevel: 51, 
                        maxLevel: 60, 
                        bossLevel: 60, 
                        minEquipLevel: 51, 
                        maxEquipLevel: 60, 
                        requiredPlayerLevel: 51 
                    }
                ],
                secret: [
                    { 
                        id: 7, 
                        name: "å·ç‹1ç²’ä¼Ÿå“¥å­˜æ”¾å¤„", 
                        minLevel: 71, 
                        maxLevel: 90, 
                        bossLevel: 95, 
                        minEquipLevel: 71, 
                        maxEquipLevel: 95, 
                        requiredPlayerLevel: 71 
                    },
                    { 
                        id: 8, 
                        name: "å·ç‹9ç²’ä¼Ÿå“¥å­˜æ”¾å¤„", 
                        minLevel: 91, 
                        maxLevel: 110, 
                        bossLevel: 115, 
                        minEquipLevel: 96, 
                        maxEquipLevel: 115, 
                        requiredPlayerLevel: 91 
                    },
                    { 
                        id: 9, 
                        name: "å·ç‹99ç²’ä¼Ÿå“¥å­˜æ”¾å¤„", 
                        minLevel: 116, 
                        maxLevel: 140, 
                        bossLevel: 145, 
                        minEquipLevel: 116, 
                        maxEquipLevel: 150, 
                        requiredPlayerLevel: 116 
                    },
                    { 
                        id: 10, 
                        name: "å·ç‹999ç²’ä¼Ÿå“¥å­˜æ”¾å¤„", 
                        minLevel: 141, 
                        maxLevel: 165, 
                        bossLevel: 170, 
                        minEquipLevel: 141, 
                        maxEquipLevel: 170, 
                        requiredPlayerLevel: 141 
                    },
                    { 
                        id: 11, 
                        name: "å·ç‹9999ç²’ä¼Ÿå“¥å­˜æ”¾å¤„", 
                        minLevel: 170, 
                        maxLevel: 200, 
                        bossLevel: 200, 
                        minEquipLevel: 170, 
                        maxEquipLevel: 200, 
                        requiredPlayerLevel: 170 
                    }
                ]
            },
            currentMap: null,
            battleLog: [],
            battleInterval: null,
            battleSpeed: 1000, // é»˜è®¤1ç§’ä¸€æ¬¡æˆ˜æ–—
            autoSellSettings: {
                quality: "rare",
                level: 10
            },
            lastActivityTime: Date.now(),
            offlineExp: 0,
            offlineGold: 0,
            offlineEquipment: []
        };

        // è£…å¤‡å“è´¨å®šä¹‰
        const equipmentQuality = {
            common: { name: "æ™®é€š", color: "#ffffff", dropRate: 0.05, baseMultiplier: 1, additionalCount: 1 },
            uncommon: { name: "ç²¾è‰¯", color: "#4CAF50", dropRate: 0.05, baseMultiplier: 1.2, additionalCount: 2 },
            rare: { name: "ç¨€æœ‰", color: "#2196F3", dropRate: 0.04, baseMultiplier: 1.5, additionalCount: 3 },
            epic: { name: "å²è¯—", color: "#9C27B0", dropRate: 0.03, baseMultiplier: 2, additionalCount: 4 },
            legendary: { name: "ä¼ è¯´", color: "#FFC107", dropRate: 0.02, baseMultiplier: 3, additionalCount: 5 },
            mythic: { name: "ç¥è¯", color: "#FF5722", dropRate: 0.01, baseMultiplier: 4, additionalCount: 6 }
        };

        // è£…å¤‡éƒ¨ä½å®šä¹‰
        const equipmentSlots = {
            'weapon-main': "ä¸»æ‰‹æ­¦å™¨",
            'weapon-off': "å‰¯æ‰‹æ­¦å™¨",
            'helmet': "å¤´ç›”",
            'armor': "æŠ¤ç”²",
            'gloves': "æ‰‹å¥—",
            'boots': "é‹å­",
            'legs': "æŠ¤è…¿",
            'necklace': "é¡¹é“¾",
            'ring-left': "å·¦æˆ’æŒ‡",
            'ring-right': "å³æˆ’æŒ‡",
            'amulet': "æŠ¤ç¬¦",
            'badge': "å¾½ç« ",
            'artefact': "æ³•å™¨"
        };

        // è£…å¤‡åŸºç¡€å±æ€§
        const equipmentBaseAttributes = {
            'weapon-main': ["æ”»å‡»åŠ›"],
            'weapon-off': ["æ”»å‡»åŠ›"],
            'helmet': ["ç”Ÿå‘½å€¼", "é­”æ³•å€¼"],
            'armor': ["ç”Ÿå‘½å€¼", "é˜²å¾¡åŠ›"],
            'gloves': ["æ”»å‡»åŠ›", "é˜²å¾¡åŠ›"],
            'boots': ["ç”Ÿå‘½å€¼", "é­”æ³•å€¼"],
            'legs': ["ç”Ÿå‘½å€¼", "é˜²å¾¡åŠ›"],
            'necklace': ["é­”æ³•å€¼", "æ”»å‡»åŠ›"],
            'ring-left': ["é­”æ³•å€¼", "æ”»å‡»åŠ›"],
            'ring-right': ["é­”æ³•å€¼", "æ”»å‡»åŠ›"],
            'amulet': ["é­”æ³•å€¼", "é˜²å¾¡åŠ›"],
            'badge': ["ç”Ÿå‘½å€¼", "é­”æ³•å€¼"],
            'artefact': ["é­”æ³•å€¼", "æ”»å‡»åŠ›"]
        };

        // è£…å¤‡é™„åŠ å±æ€§
        const equipmentAdditionalAttributes = [
            "æ”»å‡»åŠ›åŠ æˆ", "é˜²å¾¡åŠ›åŠ æˆ", "æš´å‡»ç‡", "æš´å‡»ä¼¤å®³", 
            "é‡‘å¸æ‰è½åŠ æˆ", "ç»éªŒæ‰è½åŠ æˆ", "æ°´æ™¶æ‰è½åŠ æˆ"
        ];

        // DOMå…ƒç´ å¼•ç”¨
        const elements = {
            tabs: document.querySelectorAll('.tab'),
            contents: document.querySelectorAll('.content'),
            battleLog: document.getElementById('battle-log'),
            inventoryGrid: document.getElementById('inventory-grid'),
            normalMaps: document.getElementById('normal-maps'),
            secretMaps: document.getElementById('secret-maps'),
            selectedEquipmentInfo: document.getElementById('selected-equipment-info'),
            reinforcePanel: document.getElementById('reinforce-panel'),
            evolvePanel: document.getElementById('evolve-panel'),
            resultModal: document.getElementById('result-modal'),
            awakeningModal: document.getElementById('awakening-modal'),
            wornEquipmentList: document.getElementById('worn-equipment-list'),
            battleOperationModal: document.getElementById('battle-operation-modal'),
            equipmentSelectionModal: document.getElementById('equipment-selection-modal'),
            equipmentSelectionGrid: document.getElementById('equipment-selection-grid')
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            loadGameData();
            updateUI();
            renderMaps();
            renderInventory();
            setupEventListeners();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç¦»çº¿æ”¶ç›Š
            checkOfflineGains();
        }

        // åŠ è½½æ¸¸æˆæ•°æ®
        function loadGameData() {
            const savedData = localStorage.getItem('textGameSave');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // æ£€æŸ¥æ•°æ®ç‰ˆæœ¬å…¼å®¹æ€§
                if (data.version && data.version === "1.0") {
                    Object.assign(gameData, data.gameData);
                }
            }
        }

        // ä¿å­˜æ¸¸æˆæ•°æ®
        function saveGameData() {
            const dataToSave = {
                version: "1.0",
                gameData: gameData
            };
            localStorage.setItem('textGameSave', JSON.stringify(dataToSave));
        }

        // æ›´æ–°UI
        function updateUI() {
            // æ›´æ–°è§’è‰²ä¿¡æ¯
            document.getElementById('character-level').textContent = gameData.character.level;
            document.getElementById('current-exp').textContent = gameData.character.exp;
            document.getElementById('required-exp').textContent = gameData.character.maxExp;
            document.getElementById('character-hp').textContent = gameData.character.derivedStats.hp;
            document.getElementById('character-mp').textContent = gameData.character.derivedStats.mp;
            document.getElementById('character-attack').textContent = gameData.character.derivedStats.attack;
            document.getElementById('character-defense').textContent = gameData.character.derivedStats.defense;
            document.getElementById('character-gold').textContent = gameData.character.gold;
            
            // æ›´æ–°æ°´æ™¶æ˜¾ç¤ºï¼Œé™åˆ¶å°æ•°ç‚¹åä¸¤ä½
            document.getElementById('character-crystal').textContent = parseFloat(gameData.character.crystal.toFixed(2));
            
            // æ›´æ–°é™„åŠ å±æ€§
            document.getElementById('character-crit-rate').textContent = `${gameData.character.derivedStats.critRate}%`;
            document.getElementById('character-crit-damage').textContent = `${gameData.character.derivedStats.critDamage}%`;
            document.getElementById('character-attack-bonus').textContent = `${gameData.character.derivedStats.attackBonus}%`;
            document.getElementById('character-defense-bonus').textContent = `${gameData.character.derivedStats.defenseBonus}%`;
            
            // æ›´æ–°ç»éªŒæ¡
            const expPercentage = (gameData.character.exp / gameData.character.maxExp) * 100;
            document.getElementById('exp-progress').style.width = `${expPercentage}%`;
            
            // æ›´æ–°è£…å¤‡æ§½ä½
            for (const slotId in gameData.equipment.slots) {
                const slotElement = document.getElementById(`${slotId}-content`);
                const equipment = gameData.equipment.slots[slotId];
                
                if (equipment) {
                    slotElement.innerHTML = `
                        <div class="equipment-item" data-id="${equipment.id}">
                            <div class="equipment-name">
                                <span class="quality quality-${equipment.quality}">${equipmentQuality[equipment.quality].name}</span> ${equipment.name}
                                ${equipment.reinforce > 0 ? `+${equipment.reinforce}` : ''}
                                ${equipment.evolve > 0 ? `â˜…${equipment.evolve}` : ''}
                            </div>
                            <div class="equipment-info">
                                éƒ¨ä½: ${equipmentSlots[equipment.slot]} | ç­‰çº§: ${equipment.level}
                            </div>
                            <div class="equipment-attrs">
                                ${equipment.baseAttributes.map(attr => `<div class="equipment-attr">${attr}</div>`).join('')}
                                ${equipment.additionalAttributes.map(attr => `<div class="equipment-attr">${attr}</div>`).join('')}
                            </div>
                            <button class="btn btn-outline btn-remove-equipment" data-slot="${slotId}">è„±ä¸‹</button>
                        </div>
                    `;
                } else {
                    slotElement.innerHTML = 'ç©º';
                }
            }
            
            // æ›´æ–°æˆ˜æ–—æ—¥å¿—
            while (elements.battleLog.children.length > 100) {
                elements.battleLog.removeChild(elements.battleLog.firstChild);
            }
            
            // æ›´æ–°é“åŒ é“ºä¸­çš„ç©¿æˆ´è£…å¤‡åˆ—è¡¨
            renderWornEquipment();
            
            // æ›´æ–°é™„åŠ å±æ€§æ˜¾ç¤º
            document.getElementById('exp-bonus').textContent = `${gameData.character.derivedStats.expBonus}%`;
            document.getElementById('gold-bonus').textContent = `${gameData.character.derivedStats.goldBonus}%`;
            document.getElementById('crystal-bonus').textContent = `${gameData.character.derivedStats.crystalBonus}%`;
        }

        // æ¸²æŸ“åœ°å›¾åˆ—è¡¨
        function renderMaps() {
            // æ¸²æŸ“æ™®é€šåœ°å›¾
            elements.normalMaps.innerHTML = '';
            gameData.maps.normal.forEach(map => {
                const mapElement = document.createElement('div');
                mapElement.className = `map-item ${gameData.character.level < map.requiredPlayerLevel ? 'locked' : ''}`;
                
                // å¦‚æœæ˜¯å©´å„¿å·ç‹åœ°å›¾ï¼Œæ·»åŠ ç­‰çº§é™åˆ¶æç¤º
                if (map.id === 0) {
                    mapElement.innerHTML = `
                        <div class="map-name">${map.name}</div>
                        <div class="map-info">
                            æ€ªç‰©ç­‰çº§: ${map.minLevel}-${map.maxLevel}<br>
                            BOSSç­‰çº§: ${map.bossLevel}<br>
                            æ‰è½è£…å¤‡: ${map.minEquipLevel}-${map.maxEquipLevel}çº§<br>
                            ${gameData.character.level >= 3 ? 
                            `ç­‰çº§â‰¥3æ— æ³•è¿›å…¥` : 
                            `<button class="btn" data-map-id="${map.id}">è¿›å…¥åœ°å›¾</button>`}
                        </div>
                    `;
                } else {
                    mapElement.innerHTML = `
                        <div class="map-name">${map.name}</div>
                        <div class="map-info">
                            æ€ªç‰©ç­‰çº§: ${map.minLevel}-${map.maxLevel}<br>
                            BOSSç­‰çº§: ${map.bossLevel}<br>
                            æ‰è½è£…å¤‡: ${map.minEquipLevel}-${map.maxEquipLevel}çº§<br>
                            ${gameData.character.level < map.requiredPlayerLevel ? 
                            `éœ€è¦ç­‰çº§: ${map.requiredPlayerLevel}` : 
                            `<button class="btn" data-map-id="${map.id}">è¿›å…¥åœ°å›¾</button>`}
                        </div>
                    `;
                }
                
                elements.normalMaps.appendChild(mapElement);
            });
            
            // æ¸²æŸ“ç§˜å¢ƒåœ°å›¾
            elements.secretMaps.innerHTML = '';
            gameData.maps.secret.forEach(map => {
                const mapElement = document.createElement('div');
                mapElement.className = `map-item ${gameData.character.level < map.requiredPlayerLevel ? 'locked' : ''}`;
                mapElement.innerHTML = `
                    <div class="map-name">${map.name}</div>
                    <div class="map-info">
                        æ€ªç‰©ç­‰çº§: ${map.minLevel}-${map.maxLevel}<br>
                        BOSSç­‰çº§: ${map.bossLevel}<br>
                        æ‰è½è£…å¤‡: ${map.minEquipLevel}-${map.maxEquipLevel}çº§<br>
                        ${gameData.character.level < map.requiredPlayerLevel ? 
                        `éœ€è¦ç­‰çº§: ${map.requiredPlayerLevel}` : 
                        `<button class="btn" data-map-id="${map.id}">è¿›å…¥åœ°å›¾</button>`}
                    </div>
                `;
                elements.secretMaps.appendChild(mapElement);
            });
        }

        // æ¸²æŸ“èƒŒåŒ…
        function renderInventory() {
            elements.inventoryGrid.innerHTML = '';
            
            gameData.equipment.inventory.forEach(equipment => {
                const equipmentElement = document.createElement('div');
                equipmentElement.className = `equipment-item ${equipment.locked ? 'locked' : ''} ${equipment.equipped ? 'selected' : ''}`;
                equipmentElement.dataset.id = equipment.id;
                
                equipmentElement.innerHTML = `
                    <div class="equipment-name">
                        <span class="quality quality-${equipment.quality}">${equipmentQuality[equipment.quality].name}</span> ${equipment.name}
                        ${equipment.reinforce > 0 ? `+${equipment.reinforce}` : ''}
                        ${equipment.evolve > 0 ? `â˜…${equipment.evolve}` : ''}
                    </div>
                    <div class="equipment-info">
                        éƒ¨ä½: ${equipmentSlots[equipment.slot]} | ç­‰çº§: ${equipment.level}
                    </div>
                    <div class="equipment-attrs">
                        ${equipment.baseAttributes.map(attr => `<div class="equipment-attr">${attr}</div>`).join('')}
                        ${equipment.additionalAttributes.map(attr => `<div class="equipment-attr">${attr}</div>`).join('')}
                    </div>
                    <div>
                        ${equipment.equipped ? '<button class="btn btn-outline btn-unequip">è„±ä¸‹</button>' : '<button class="btn btn-outline btn-wear">ç©¿æˆ´</button>'}
                        ${equipment.locked ? '<button class="btn btn-outline btn-unlock">è§£é”</button>' : '<button class="btn btn-outline btn-lock">é”å®š</button>'}
                        <button class="btn btn-outline btn-sell">å”®å–</button>
                    </div>
                `;
                
                elements.inventoryGrid.appendChild(equipmentElement);
            });
        }

        // æ¸²æŸ“ç©¿æˆ´çš„è£…å¤‡åˆ—è¡¨ï¼ˆç”¨äºé“åŒ é“ºï¼‰
        function renderWornEquipment() {
            elements.wornEquipmentList.innerHTML = '';
            
            for (const slotId in gameData.equipment.slots) {
                const equipment = gameData.equipment.slots[slotId];
                if (equipment) {
                    const equipmentElement = document.createElement('div');
                    equipmentElement.className = 'equipment-item';
                    equipmentElement.dataset.id = equipment.id;
                    
                    equipmentElement.innerHTML = `
                        <div class="equipment-name">
                            <span class="quality quality-${equipment.quality}">${equipmentQuality[equipment.quality].name}</span> ${equipment.name}
                            ${equipment.reinforce > 0 ? `+${equipment.reinforce}` : ''}
                            ${equipment.evolve > 0 ? `â˜…${equipment.evolve}` : ''}
                        </div>
                        <div class="equipment-info">
                            éƒ¨ä½: ${equipmentSlots[equipment.slot]} | ç­‰çº§: ${equipment.level}
                        </div>
                        <div class="equipment-attrs">
                            ${equipment.baseAttributes.map(attr => `<div class="equipment-attr">${attr}</div>`).join('')}
                            ${equipment.additionalAttributes.map(attr => `<div class="equipment-attr">${attr}</div>`).join('')}
                        </div>
                        <div>
                            <button class="btn btn-outline btn-select-equipment" data-slot="${slotId}">é€‰æ‹©</button>
                        </div>
                    `;
                    
                    elements.wornEquipmentList.appendChild(equipmentElement);
                }
            }
        }

        // ç”Ÿæˆéšæœºè£…å¤‡
        function generateEquipment(slot, level, quality) {
            const qualityData = equipmentQuality[quality];
            const baseAttributes = equipmentBaseAttributes[slot];
            
            // ç”ŸæˆåŸºç¡€å±æ€§å€¼ï¼Œæ ¹æ®è£…å¤‡ç­‰çº§å’Œå“è´¨
            const baseAttrValues = baseAttributes.map(attr => {
                if (attr.includes("æ”»å‡»åŠ›")) {
                    const baseValue = Math.floor(level * 2);
                    const qualityMultiplier = qualityData.baseMultiplier;
                    return `${attr}: +${Math.floor(baseValue * qualityMultiplier)}`;
                } else if (attr.includes("é˜²å¾¡åŠ›")) {
                    const baseValue = Math.floor(level * 1.5);
                    const qualityMultiplier = qualityData.baseMultiplier;
                    return `${attr}: +${Math.floor(baseValue * qualityMultiplier)}`;
                } else if (attr.includes("ç”Ÿå‘½å€¼")) {
                    const baseValue = Math.floor(level * 5);
                    const qualityMultiplier = qualityData.baseMultiplier;
                    return `${attr}: +${Math.floor(baseValue * qualityMultiplier)}`;
                } else if (attr.includes("é­”æ³•å€¼")) {
                    const baseValue = Math.floor(level * 3);
                    const qualityMultiplier = qualityData.baseMultiplier;
                    return `${attr}: +${Math.floor(baseValue * qualityMultiplier)}`;
                }
            });
            
            // ç”Ÿæˆé™„åŠ å±æ€§ï¼Œæ ¹æ®å“è´¨
            const additionalCount = Math.min(
                qualityData.additionalCount,
                8 // æœ€å¤§8æ¡
            );
            
            const additionalAttributes = [];
            for (let i = 0; i < additionalCount; i++) {
                const attrType = equipmentAdditionalAttributes[Math.floor(Math.random() * equipmentAdditionalAttributes.length)];
                let value;
                
                if (attrType.includes("åŠ æˆ") || attrType.includes("ç‡")) {
                    const baseValue = Math.floor(Math.random() * 10) + 1;
                    const qualityMultiplier = qualityData.baseMultiplier;
                    value = `${attrType}: +${Math.floor(baseValue * qualityMultiplier)}%`;
                } else {
                    const baseValue = Math.floor(Math.random() * 5) + 1;
                    const qualityMultiplier = qualityData.baseMultiplier;
                    value = `${attrType}: +${Math.floor(baseValue * qualityMultiplier)}`;
                }
                
                additionalAttributes.push(value);
            }
            
            // ç”Ÿæˆè£…å¤‡åç§°
            const names = [
                "å‹‡è€…", "åŠ›é‡", "æ•æ·", "æ™ºæ…§", "å®ˆæŠ¤", "æ¯ç­", "ç¥åœ£", "æš—å½±", 
                "ç«ç„°", "å†°éœœ", "é›·éœ†", "è‡ªç„¶", "æš—é»‘", "å…‰æ˜", "æ··æ²Œ", "ç§©åº"
            ];
            
            const name = `${names[Math.floor(Math.random() * names.length)]}${slot.replace(/-/g, "")}`;
            
            return {
                id: Date.now() + Math.floor(Math.random() * 1000),
                slot: slot,
                name: name,
                quality: quality,
                level: level,
                baseAttributes: baseAttrValues,
                additionalAttributes: additionalAttributes,
                locked: false,
                equipped: false,
                reinforce: 0,
                evolve: 0
            };
        }

        // å¼€å§‹æˆ˜æ–—
        function startBattle(mapId) {
            // åœæ­¢ä¹‹å‰çš„æˆ˜æ–—
            if (gameData.battleInterval) {
                clearInterval(gameData.battleInterval);
            }
            
            // æŸ¥æ‰¾åœ°å›¾
            let map = null;
            gameData.maps.normal.forEach(m => {
                if (m.id === mapId) map = m;
            });
            
            if (!map) {
                gameData.maps.secret.forEach(m => {
                    if (m.id === mapId) map = m;
                });
            }
            
            if (!map) return;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å©´å„¿å·ç‹åœ°å›¾ï¼Œä¸”ç©å®¶ç­‰çº§â‰¥3æ—¶æ— æ³•è¿›å…¥
            if (map.id === 0 && gameData.character.level >= 3) {
                addBattleLog("ä½ çš„ç­‰çº§å·²è¾¾åˆ°3çº§ï¼Œæ— æ³•è¿›å…¥å©´å„¿å·ç‹åœ°å›¾");
                return;
            }
            
            gameData.currentMap = map;
            
            // å¼€å§‹æˆ˜æ–—å¾ªç¯
            gameData.battleInterval = setInterval(() => {
                battle();
            }, gameData.battleSpeed);
        }

        // æˆ˜æ–—å‡½æ•°
        function battle() {
            const map = gameData.currentMap;
            
            // åˆ¤æ–­æ˜¯æ™®é€šæ€ªç‰©è¿˜æ˜¯BOSS
            let monsterLevel;
            if (map.id === 0) { // å©´å„¿å·ç‹åœ°å›¾
                monsterLevel = 1; // å¼ºåˆ¶æ€ªç‰©ç­‰çº§ä¸º1
            } else {
                const isBoss = Math.random() < 0.05; // 5%å‡ ç‡é‡åˆ°BOSS
                if (isBoss) {
                    monsterLevel = map.bossLevel;
                } else {
                    monsterLevel = Math.floor(Math.random() * (map.maxLevel - map.minLevel + 1)) + map.minLevel;
                }
            }
            
            // æ ¹æ®ç­‰çº§è°ƒæ•´æ€ªç‰©å±æ€§
            let attack, defense, hp;
            
            if (monsterLevel >= 11) {
                if (monsterLevel === map.bossLevel && map.id !== 0) {
                    // BOSSå±æ€§
                    attack = 25 * monsterLevel;
                    defense = 30 * monsterLevel;
                    hp = 50 * monsterLevel;
                } else {
                    // æ™®é€šæ€ªç‰©å±æ€§
                    attack = 15 * monsterLevel;
                    defense = 18 * monsterLevel;
                    hp = 30 * monsterLevel;
                }
            } else {
                // 1-10çº§æ€ªç‰©å±æ€§ä¿æŒä¸å˜
                attack = Math.floor(2.5 * monsterLevel);
                defense = Math.floor(2.5 * monsterLevel);
                hp = Math.floor(6 * monsterLevel);
            }
            
            // åˆ›å»ºæ€ªç‰©å¯¹è±¡
            const monster = {
                level: monsterLevel,
                attack: attack,
                defense: defense,
                hp: hp,
                isBoss: monsterLevel === map.bossLevel
            };
            
            // è®¡ç®—æˆ˜æ–—ç»“æœ
            const playerAttack = gameData.character.derivedStats.attack;
            const playerDefense = gameData.character.derivedStats.defense;
            
            // ç®€åŒ–æˆ˜æ–—é€»è¾‘ï¼Œç›´æ¥è®¡ç®—ä¼¤å®³
            const damage = Math.max(1, playerAttack - monster.defense);
            const monsterDamage = Math.max(1, monster.attack - playerDefense);
            
            // è®¡ç®—æˆ˜æ–—è½®æ•°
            const rounds = Math.ceil(monster.hp / damage);
            const playerHpLost = Math.min(monsterDamage * rounds, gameData.character.derivedStats.hp);
            
            // æˆ˜æ–—æ—¥å¿—
            addBattleLog(`é‡åˆ°${map.name}çš„${monster.isBoss ? 'BOSS' : 'æ€ªç‰©'}ï¼Œç­‰çº§${monster.level}ï¼Œæ”»å‡»åŠ›${monster.attack}ï¼Œé˜²å¾¡åŠ›${monster.defense}ï¼Œç”Ÿå‘½å€¼${monster.hp}`);
            
            if (playerHpLost >= gameData.character.derivedStats.hp) {
                // ç©å®¶æ­»äº¡
                addBattleLog(`ä½ è¢«å‡»è´¥äº†ï¼2ç§’åå¤æ´»...`);
                clearInterval(gameData.battleInterval);
                gameData.currentMap = null;
                setTimeout(() => {
                    startBattle(map.id);
                }, 2000); // å¤æ´»æ—¶é—´ä¿®æ”¹ä¸º2ç§’
            } else {
                // ç©å®¶èƒœåˆ©
                // è®¡ç®—åŸºç¡€ç»éªŒå’Œé‡‘å¸
                let expGain = Math.floor(monster.level * 10);
                let goldGain = Math.floor(monster.level * 5);
                
                // åº”ç”¨ç»éªŒæ‰è½åŠ æˆ
                const expBonus = parseFloat(gameData.character.derivedStats.expBonus || 0);
                expGain = Math.floor(expGain * (1 + expBonus / 100));
                
                // åº”ç”¨é‡‘å¸æ‰è½åŠ æˆ
                const goldBonus = parseFloat(gameData.character.derivedStats.goldBonus || 0);
                goldGain = Math.floor(goldGain * (1 + goldBonus / 100));
                
                gameData.character.exp += expGain;
                gameData.character.gold += goldGain;
                
                addBattleLog(`å‡»è´¥äº†${monster.isBoss ? 'BOSS' : 'æ€ªç‰©'}ï¼Œè·å¾—${expGain}ç»éªŒï¼Œ${goldGain}é‡‘å¸`);
                
                // æ£€æŸ¥æ˜¯å¦å‡çº§
                checkLevelUp();
                
                // æ‰è½ç‰©å“
                if (Math.random() < 0.1) { // 10%å‡ ç‡æ‰è½è£…å¤‡
                    const equipLevel = monster.level;
                    const qualityRoll = Math.random();
                    let quality = 'common';
                    
                    // æ ¹æ®æ¦‚ç‡é€‰æ‹©å“è´¨
                    let cumulativeRate = 0;
                    for (const q in equipmentQuality) {
                        cumulativeRate += equipmentQuality[q].dropRate;
                        if (qualityRoll <= cumulativeRate) {
                            quality = q;
                            break;
                        }
                    }
                    
                    const equipment = generateEquipment(
                        Object.keys(equipmentSlots)[Math.floor(Math.random() * Object.keys(equipmentSlots).length)],
                        equipLevel,
                        quality
                    );
                    
                    // æ£€æŸ¥æ˜¯å¦ç¬¦åˆè‡ªåŠ¨å”®å–æ¡ä»¶
                    if (equipment.quality <= gameData.autoSellSettings.quality && equipment.level <= gameData.autoSellSettings.level) {
                        // è®¡ç®—å”®å–ä»·æ ¼
                        let basePrice = equipment.level * 10;
                        let qualityMultiplier = 1;
                        
                        switch (equipment.quality) {
                            case 'uncommon': qualityMultiplier = 1.5; break;
                            case 'rare': qualityMultiplier = 2; break;
                            case 'epic': qualityMultiplier = 3; break;
                            case 'legendary': qualityMultiplier = 5; break;
                            case 'mythic': qualityMultiplier = 10; break;
                        }
                        
                        const sellPrice = Math.floor(basePrice * qualityMultiplier);
                        gameData.character.gold += sellPrice;
                        
                        addBattleLog(`è‡ªåŠ¨å”®å–äº†${equipmentQuality[equipment.quality].name}è£…å¤‡ï¼š${equipment.name}ï¼Œè·å¾—${sellPrice}é‡‘å¸`);
                    } else {
                        gameData.equipment.inventory.push(equipment);
                        addBattleLog(`è·å¾—äº†${equipmentQuality[equipment.quality].name}è£…å¤‡ï¼š${equipment.name}`);
                        renderInventory();
                    }
                }
                
                // æ‰è½æ°´æ™¶
                if (Math.random() < 0.02) { // 2%å‡ ç‡æ‰è½æ°´æ™¶
                    let crystalGain = monster.isBoss ? Math.floor(Math.random() * 3) + 1 : Math.random() < 0.5 ? 0.01 : 0.05;
                    
                    // åº”ç”¨æ°´æ™¶æ‰è½åŠ æˆ
                    const crystalBonus = parseFloat(gameData.character.derivedStats.crystalBonus || 0);
                    crystalGain = crystalBonus > 0 ? crystalGain * (1 + crystalBonus / 100) : crystalGain;
                    
                    gameData.character.crystal += crystalGain;
                    addBattleLog(`è·å¾—äº†${crystalGain.toFixed(2)}æ°´æ™¶`);
                }
            }
            
            // å®æ—¶ä¿å­˜æ¸¸æˆæ•°æ®
            saveGameData();
            
            // æ›´æ–°UI
            updateUI();
        }

        // æ·»åŠ æˆ˜æ–—æ—¥å¿—
        function addBattleLog(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = message;
            
            elements.battleLog.appendChild(logEntry);
            elements.battleLog.scrollTop = elements.battleLog.scrollHeight;
            
            // ä¿å­˜åˆ°æ¸¸æˆæ•°æ®
            gameData.battleLog.push(message);
        }

        // æ£€æŸ¥å‡çº§
        function checkLevelUp() {
            while (gameData.character.exp >= gameData.character.maxExp && gameData.character.level < 200) {
                gameData.character.level++;
                gameData.character.exp -= gameData.character.maxExp;
                gameData.character.maxExp = gameData.character.level * gameData.character.level * 100;
                
                // æ›´æ–°å±æ€§
                updateDerivedStats();
                
                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°200çº§
                if (gameData.character.level === 200) {
                    showAwakeningModal();
                }
                
                addBattleLog(`æ­å–œï¼å‡çº§åˆ°${gameData.character.level}çº§ï¼`);
                
                // æ›´æ–°UI
                updateUI();
            }
        }

        // æ›´æ–°è¡ç”Ÿå±æ€§
        function updateDerivedStats() {
            const level = gameData.character.level;
            
            // åˆå§‹åŒ–åŸºç¡€å±æ€§
            let attack = 5;
            let defense = 5;
            let hp = 30;
            let mp = 30;
            
            // éå†è£…å¤‡æ§½ä½
            for (const slotId in gameData.equipment.slots) {
                const equipment = gameData.equipment.slots[slotId];
                if (!equipment) continue;
                
                // è§£æåŸºç¡€å±æ€§
                equipment.baseAttributes.forEach(attr => {
                    if (attr.includes("æ”»å‡»åŠ›")) {
                        const value = parseInt(attr.match(/\d+/)[0]);
                        attack += value;
                    } else if (attr.includes("é˜²å¾¡åŠ›")) {
                        const value = parseInt(attr.match(/\d+/)[0]);
                        defense += value;
                    } else if (attr.includes("ç”Ÿå‘½å€¼")) {
                        const value = parseInt(attr.match(/\d+/)[0]);
                        hp += value;
                    } else if (attr.includes("é­”æ³•å€¼")) {
                        const value = parseInt(attr.match(/\d+/)[0]);
                        mp += value;
                    }
                });
            }
            
            // åˆå§‹åŒ–åŠ æˆå±æ€§
            gameData.character.derivedStats.expBonus = 0;
            gameData.character.derivedStats.goldBonus = 0;
            gameData.character.derivedStats.crystalBonus = 0;
            gameData.character.derivedStats.critRate = 0;
            gameData.character.derivedStats.critDamage = 0;
            gameData.character.derivedStats.attackBonus = 0;
            gameData.character.derivedStats.defenseBonus = 0;
            
            // éå†è£…å¤‡æ§½ä½ï¼Œæ›´æ–°é™„åŠ å±æ€§
            for (const slotId in gameData.equipment.slots) {
                const equipment = gameData.equipment.slots[slotId];
                if (!equipment) continue;
                
                // è§£æé™„åŠ å±æ€§
                equipment.additionalAttributes.forEach(attr => {
                    if (attr.includes("ç»éªŒæ‰è½åŠ æˆ")) {
                        const percentage = parseInt(attr.match(/\d+/)[0]);
                        gameData.character.derivedStats.expBonus += percentage;
                    } else if (attr.includes("é‡‘å¸æ‰è½åŠ æˆ")) {
                        const percentage = parseInt(attr.match(/\d+/)[0]);
                        gameData.character.derivedStats.goldBonus += percentage;
                    } else if (attr.includes("æ°´æ™¶æ‰è½åŠ æˆ")) {
                        const percentage = parseInt(attr.match(/\d+/)[0]);
                        gameData.character.derivedStats.crystalBonus += percentage;
                    } else if (attr.includes("æš´å‡»ç‡")) {
                        const percentage = parseInt(attr.match(/\d+/)[0]);
                        gameData.character.derivedStats.critRate += percentage;
                    } else if (attr.includes("æš´å‡»ä¼¤å®³")) {
                        const percentage = parseInt(attr.match(/\d+/)[0]);
                        gameData.character.derivedStats.critDamage += percentage;
                    } else if (attr.includes("æ”»å‡»åŠ›åŠ æˆ")) {
                        const percentage = parseInt(attr.match(/\d+/)[0]);
                        gameData.character.derivedStats.attackBonus += percentage;
                    } else if (attr.includes("é˜²å¾¡åŠ›åŠ æˆ")) {
                        const percentage = parseInt(attr.match(/\d+/)[0]);
                        gameData.character.derivedStats.defenseBonus += percentage;
                    }
                });
            }
            
            // åº”ç”¨ç™¾åˆ†æ¯”åŠ æˆåˆ°åŸºç¡€å±æ€§
            attack = Math.floor(attack * (1 + gameData.character.derivedStats.attackBonus / 100));
            defense = Math.floor(defense * (1 + gameData.character.derivedStats.defenseBonus / 100));
            
            // æ›´æ–°è¡ç”Ÿå±æ€§
            gameData.character.derivedStats.attack = attack;
            gameData.character.derivedStats.defense = defense;
            gameData.character.derivedStats.hp = hp;
            gameData.character.derivedStats.mp = mp;
            
            // æ›´æ–°UI
            updateUI();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ ‡ç­¾åˆ‡æ¢
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                    elements.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // æ›´æ–°å†…å®¹æ˜¾ç¤º
                    elements.contents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                    
                    // ç‰¹æ®Šå†…å®¹æ›´æ–°
                    if (tabId === 'inventory') {
                        renderInventory();
                    } else if (tabId === 'equipment') {
                        updateUI();
                    } else if (tabId === 'blacksmith') {
                        renderWornEquipment();
                    }
                });
            });
            
            // åœ°å›¾ç‚¹å‡»äº‹ä»¶
            document.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('btn') && e.target.dataset.mapId) {
                    const mapId = parseInt(e.target.dataset.mapId);
                    startBattle(mapId);
                }
            });
            
            // è£…å¤‡ç©¿æˆ´/è„±ä¸‹
            document.addEventListener('click', (e) => {
                // æ£€æŸ¥æ˜¯å¦å¤„äºæˆ˜æ–—çŠ¶æ€
                if (gameData.battleInterval) {
                    if (e.target && (e.target.classList.contains('btn-wear') || e.target.classList.contains('btn-unequip') || e.target.classList.contains('btn-remove-equipment'))) {
                        showBattleOperationModal();
                        return;
                    }
                }
                
                if (e.target && e.target.classList.contains('btn-wear')) {
                    const equipmentElement = e.target.closest('.equipment-item');
                    const equipmentId = parseInt(equipmentElement.dataset.id);
                    const equipment = gameData.equipment.inventory.find(e => e.id === equipmentId);
                    
                    if (equipment) {
                        // æ£€æŸ¥è£…å¤‡ç­‰çº§æ˜¯å¦é«˜äºè§’è‰²ç­‰çº§
                        if (equipment.level > gameData.character.level) {
                            addBattleLog(`è£…å¤‡ç­‰çº§${equipment.level}é«˜äºä½ çš„è§’è‰²ç­‰çº§${gameData.character.level}ï¼Œæ— æ³•ç©¿æˆ´`);
                            return;
                        }
                        
                        // æ£€æŸ¥è¯¥éƒ¨ä½æ˜¯å¦å·²æœ‰è£…å¤‡
                        if (gameData.equipment.slots[equipment.slot]) {
                            addBattleLog(`è¯¥éƒ¨ä½å·²æœ‰è£…å¤‡ï¼Œæ— æ³•ç©¿æˆ´`);
                            return;
                        }
                        
                        // ç©¿æˆ´æ–°è£…å¤‡
                        gameData.equipment.slots[equipment.slot] = equipment;
                        equipment.equipped = true;
                        
                        // æ›´æ–°å±æ€§
                        updateDerivedStats();
                        renderInventory();
                        
                        // è‡ªåŠ¨ä¿å­˜
                        saveGameData();
                    }
                } else if (e.target && e.target.classList.contains('btn-unequip')) {
                    const equipmentElement = e.target.closest('.equipment-item');
                    const equipmentId = parseInt(equipmentElement.dataset.id);
                    const equipment = gameData.equipment.inventory.find(e => e.id === equipmentId);
                    
                    if (equipment) {
                        // è„±ä¸‹è£…å¤‡
                        equipment.equipped = false;
                        gameData.equipment.slots[equipment.slot] = null;
                        
                        // æ›´æ–°å±æ€§
                        updateDerivedStats();
                        
                        addBattleLog(`è„±ä¸‹äº†${equipment.name}`);
                        renderInventory();
                        
                        // è‡ªåŠ¨ä¿å­˜
                        saveGameData();
                    }
                } else if (e.target && e.target.classList.contains('btn-remove-equipment')) {
                    const equipmentElement = e.target.closest('.equipment-item');
                    const equipmentId = parseInt(equipmentElement.dataset.id);
                    
                    // æ‰¾åˆ°è£…å¤‡æ‰€åœ¨çš„æ§½ä½
                    let slotId = null;
                    for (const slot in gameData.equipment.slots) {
                        if (gameData.equipment.slots[slot] && gameData.equipment.slots[slot].id === equipmentId) {
                            slotId = slot;
                            break;
                        }
                    }
                    
                    if (slotId) {
                        const equipment = gameData.equipment.slots[slotId];
                        
                        // è„±ä¸‹è£…å¤‡
                        equipment.equipped = false;
                        gameData.equipment.slots[slotId] = null;
                        
                        // æ›´æ–°å±æ€§
                        updateDerivedStats();
                        
                        addBattleLog(`è„±ä¸‹äº†${equipment.name}`);
                        updateUI();
                        
                        // è‡ªåŠ¨ä¿å­˜
                        saveGameData();
                    } else {
                        addBattleLog('æœªæ‰¾åˆ°å¯¹åº”çš„è£…å¤‡æ§½ä½');
                    }
                }
            });
            
            // é”å®š/è§£é”è£…å¤‡
            document.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('btn-lock')) {
                    const equipmentElement = e.target.closest('.equipment-item');
                    const equipmentId = parseInt(equipmentElement.dataset.id);
                    const equipment = gameData.equipment.inventory.find(e => e.id === equipmentId);
                    
                    if (equipment) {
                        equipment.locked = true;
                        e.target.textContent = 'è§£é”';
                        renderInventory();
                    }
                } else if (e.target && e.target.classList.contains('btn-unlock')) {
                    const equipmentElement = e.target.closest('.equipment-item');
                    const equipmentId = parseInt(equipmentElement.dataset.id);
                    const equipment = gameData.equipment.inventory.find(e => e.id === equipmentId);
                    
                    if (equipment) {
                        equipment.locked = false;
                        e.target.textContent = 'é”å®š';
                        renderInventory();
                    }
                }
            });
            
            // å”®å–è£…å¤‡
            document.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('btn-sell')) {
                    const equipmentElement = e.target.closest('.equipment-item');
                    const equipmentId = parseInt(equipmentElement.dataset.id);
                    const equipmentIndex = gameData.equipment.inventory.findIndex(e => e.id === equipmentId);
                    
                    if (equipmentIndex !== -1 && !gameData.equipment.inventory[equipmentIndex].locked) {
                        const equipment = gameData.equipment.inventory[equipmentIndex];
                        
                        // è®¡ç®—å”®å–ä»·æ ¼
                        let basePrice = equipment.level * 10;
                        let qualityMultiplier = 1;
                        
                        switch (equipment.quality) {
                            case 'uncommon': qualityMultiplier = 1.5; break;
                            case 'rare': qualityMultiplier = 2; break;
                            case 'epic': qualityMultiplier = 3; break;
                            case 'legendary': qualityMultiplier = 5; break;
                            case 'mythic': qualityMultiplier = 10; break;
                        }
                        
                        const sellPrice = Math.floor(basePrice * qualityMultiplier);
                        gameData.character.gold += sellPrice;
                        
                        // ä»èƒŒåŒ…ä¸­ç§»é™¤
                        gameData.equipment.inventory.splice(equipmentIndex, 1);
                        
                        // å¦‚æœè£…å¤‡æ­£åœ¨ç©¿æˆ´ï¼Œä»è£…å¤‡æ§½ä¸­ç§»é™¤
                        if (equipment.equipped) {
                            gameData.equipment.slots[equipment.slot] = null;
                            updateDerivedStats();
                        }
                        
                        addBattleLog(`å”®å–äº†${equipment.name}ï¼Œè·å¾—${sellPrice}é‡‘å¸`);
                        updateUI();
                        renderInventory();
                        
                        // è‡ªåŠ¨ä¿å­˜
                        saveGameData();
                    }
                }
            });
            
            // ä¸€é”®å”®å–æ‰€æœ‰è£…å¤‡
            document.getElementById('sell-all-btn').addEventListener('click', () => {
                let totalGold = 0;
                
                // ç­›é€‰å¯å”®å–çš„è£…å¤‡
                const sellableEquipment = gameData.equipment.inventory.filter(equipment => {
                    return !equipment.locked && !equipment.equipped && 
                           equipment.quality <= gameData.autoSellSettings.quality && 
                           equipment.level <= gameData.autoSellSettings.level;
                });
                
                // å”®å–è£…å¤‡
                sellableEquipment.forEach(equipment => {
                    let basePrice = equipment.level * 10;
                    let qualityMultiplier = 1;
                    
                    switch (equipment.quality) {
                        case 'uncommon': qualityMultiplier = 1.5; break;
                        case 'rare': qualityMultiplier = 2; break;
                        case 'epic': qualityMultiplier = 3; break;
                        case 'legendary': qualityMultiplier = 5; break;
                        case 'mythic': qualityMultiplier = 10; break;
                    }
                    
                    const sellPrice = Math.floor(basePrice * qualityMultiplier);
                    totalGold += sellPrice;
                    
                    // ä»èƒŒåŒ…ä¸­ç§»é™¤
                    const index = gameData.equipment.inventory.findIndex(e => e.id === equipment.id);
                    if (index !== -1) {
                        gameData.equipment.inventory.splice(index, 1);
                    }
                });
                
                // æ›´æ–°é‡‘å¸
                gameData.character.gold += totalGold;
                
                addBattleLog(`ä¸€é”®å”®å–äº†${sellableEquipment.length}ä»¶è£…å¤‡ï¼Œè·å¾—${totalGold}é‡‘å¸`);
                updateUI();
                renderInventory();
                
                // è‡ªåŠ¨ä¿å­˜
                saveGameData();
            });
            
            // è‡ªåŠ¨å”®å–è®¾ç½®
            document.getElementById('save-auto-sell-settings').addEventListener('click', () => {
                gameData.autoSellSettings.quality = document.getElementById('auto-sell-quality').value;
                gameData.autoSellSettings.level = parseInt(document.getElementById('auto-sell-level').value);
                
                addBattleLog(`è‡ªåŠ¨å”®å–è®¾ç½®å·²æ›´æ–°ï¼šå“è´¨ä½äºç­‰äº${equipmentQuality[gameData.autoSellSettings.quality].name}ï¼Œç­‰çº§ä½äº${gameData.autoSellSettings.level}`);
            });
            
            // é€‰æ‹©è£…å¤‡è¿›è¡Œå¼ºåŒ–æˆ–è¿›åŒ–
            document.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('btn-select-equipment')) {
                    // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                    document.querySelectorAll('.equipment-item.selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // é€‰ä¸­å½“å‰è£…å¤‡
                    const equipmentElement = e.target.closest('.equipment-item');
                    equipmentElement.classList.add('selected');
                    
                    const equipmentId = parseInt(equipmentElement.dataset.id);
                    const equipment = gameData.equipment.inventory.find(e => e.id === equipmentId);
                    
                    if (equipment) {
                        // æ›´æ–°å¼ºåŒ–å’Œè¿›åŒ–é¢æ¿
                        document.getElementById('current-reinforce').textContent = equipment.reinforce;
                        document.getElementById('reinforce-cost').textContent = Math.floor(100 * Math.pow(1.1, equipment.reinforce));
                        
                        document.getElementById('current-evolve').textContent = equipment.evolve;
                        document.getElementById('evolve-cost').textContent = 1; // æ¯æ¬¡è¿›åŒ–æ¶ˆè€—1å·
                        
                        // æ˜¾ç¤ºå¼ºåŒ–å’Œè¿›åŒ–é¢æ¿
                        document.getElementById('reinforce-panel').style.display = 'block';
                        document.getElementById('evolve-panel').style.display = 'block';
                    }
                }
            });
            
            // å¼ºåŒ–è£…å¤‡
            document.getElementById('do-reinforce').addEventListener('click', () => {
                const selectedEquipment = document.querySelector('.equipment-item.selected');
                if (!selectedEquipment) {
                    addBattleLog('è¯·å…ˆé€‰æ‹©ä¸€ä»¶è£…å¤‡è¿›è¡Œå¼ºåŒ–');
                    return;
                }
                
                const equipmentId = parseInt(selectedEquipment.dataset.id);
                const equipment = gameData.equipment.inventory.find(e => e.id === equipmentId);
                
                if (!equipment) return;
                
                // æ£€æŸ¥æ˜¯å¦å¤„äºæˆ˜æ–—çŠ¶æ€
                if (gameData.battleInterval) {
                    showBattleOperationModal();
                    return;
                }
                
                // è®¡ç®—å¼ºåŒ–æˆæœ¬
                const cost = Math.floor(100 * Math.pow(1.1, equipment.reinforce));
                
                if (gameData.character.gold < cost) {
                    showResultModal(`å¼ºåŒ–å¤±è´¥ï¼šé‡‘å¸ä¸è¶³ï¼Œéœ€è¦${cost}é‡‘å¸`, 'danger');
                    return;
                }
                
                // æ‰£é™¤é‡‘å¸
                gameData.character.gold -= cost;
                
                // å¼ºåŒ–ç»“æœ
                const success = Math.random() < 0.1; // 10%æˆåŠŸç‡
                
                if (success) {
                    equipment.reinforce++;
                    addBattleLog(`å¼ºåŒ–æˆåŠŸï¼${equipment.name}å¼ºåŒ–è‡³+${equipment.reinforce}`);
                    
                    // æ˜¾ç¤ºå¼ºåŒ–ç»“æœå¼¹çª—
                    showResultModal(`å¼ºåŒ–æˆåŠŸï¼${equipment.name}å¼ºåŒ–è‡³+${equipment.reinforce}`, 'success');
                } else {
                    addBattleLog(`å¼ºåŒ–å¤±è´¥ï¼${equipment.name}å¼ºåŒ–å¤±è´¥`);
                    
                    // æ˜¾ç¤ºå¼ºåŒ–ç»“æœå¼¹çª—
                    showResultModal(`å¼ºåŒ–å¤±è´¥ï¼${equipment.name}å¼ºåŒ–å¤±è´¥`, 'danger');
                }
                
                updateUI();
                renderWornEquipment();
                
                // è‡ªåŠ¨ä¿å­˜
                saveGameData();
            });
            
            // è¿›åŒ–è£…å¤‡
            document.getElementById('do-evolve').addEventListener('click', () => {
                const selectedEquipment = document.querySelector('.equipment-item.selected');
                if (!selectedEquipment) {
                    addBattleLog('è¯·å…ˆé€‰æ‹©ä¸€ä»¶è£…å¤‡è¿›è¡Œè¿›åŒ–');
                    return;
                }
                
                const equipmentId = parseInt(selectedEquipment.dataset.id);
                const equipment = gameData.equipment.inventory.find(e => e.id === equipmentId);
                
                if (!equipment) return;
                
                // æ£€æŸ¥æ˜¯å¦å¤„äºæˆ˜æ–—çŠ¶æ€
                if (gameData.battleInterval) {
                    showBattleOperationModal();
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å·è½´
                const scrollCount = gameData.equipment.inventory.filter(e => e.name === "æå‡å·è½´").length;
                
                if (scrollCount === 0) {
                    addBattleLog('è¿›åŒ–å¤±è´¥ï¼šæ²¡æœ‰è¶³å¤Ÿçš„æå‡å·è½´');
                    return;
                }
                
                // æ¶ˆè€—å·è½´
                const scrollIndex = gameData.equipment.inventory.findIndex(e => e.name === "æå‡å·è½´");
                if (scrollIndex !== -1) {
                    gameData.equipment.inventory.splice(scrollIndex, 1);
                }
                
                // è¿›åŒ–ç»“æœ
                const success = Math.random() < 0.1; // 10%æˆåŠŸç‡
                
                if (success) {
                    equipment.evolve++;
                    addBattleLog(`è¿›åŒ–æˆåŠŸï¼${equipment.name}è¿›åŒ–è‡³â˜…${equipment.evolve}`);
                    
                    // æ˜¾ç¤ºè¿›åŒ–ç»“æœå¼¹çª—
                    showResultModal(`è¿›åŒ–æˆåŠŸï¼${equipment.name}è¿›åŒ–è‡³â˜…${equipment.evolve}`, 'success');
                } else {
                    addBattleLog(`è¿›åŒ–å¤±è´¥ï¼${equipment.name}è¿›åŒ–å¤±è´¥`);
                    
                    // æ˜¾ç¤ºè¿›åŒ–ç»“æœå¼¹çª—
                    showResultModal(`è¿›åŒ–å¤±è´¥ï¼${equipment.name}è¿›åŒ–å¤±è´¥`, 'danger');
                }
                
                updateUI();
                renderWornEquipment();
                
                // è‡ªåŠ¨ä¿å­˜
                saveGameData();
            });
            
            // è´­ä¹°è¿›åŒ–å·è½´
            document.getElementById('buy-evolve-scroll').addEventListener('click', () => {
                const crystalCost = 10; // 10æ°´æ™¶è´­ä¹°1å·
                const scroll = generateEquipment('badge', 1, 'common');
                scroll.name = "æå‡å·è½´";
                scroll.baseAttributes = [];
                scroll.additionalAttributes = [];
                
                if (gameData.character.crystal >= crystalCost) {
                    gameData.character.crystal -= crystalCost;
                    gameData.equipment.inventory.push(scroll);
                    addBattleLog(`è´­ä¹°äº†1ä¸ªæå‡å·è½´ï¼ŒèŠ±è´¹${crystalCost}æ°´æ™¶`);
                    renderInventory();
                } else {
                    addBattleLog('æ°´æ™¶ä¸è¶³ï¼Œæ— æ³•è´­ä¹°æå‡å·è½´');
                }
            });
            
            // æš‚åœæˆ˜æ–—æŒ‰é’®
            document.getElementById('pause-battle').addEventListener('click', () => {
                if (gameData.battleInterval) {
                    clearInterval(gameData.battleInterval);
                    gameData.battleInterval = null;
                    addBattleLog('æˆ˜æ–—å·²æš‚åœ');
                } else {
                    addBattleLog('å½“å‰æ²¡æœ‰æˆ˜æ–—');
                }
            });
            
            // å…³é—­æˆ˜æ–—æ“ä½œæç¤ºå¼¹çª—
            document.getElementById('battle-operation-close-btn').addEventListener('click', () => {
                document.getElementById('battle-operation-modal').style.display = 'none';
            });
            
            // å…³é—­ç»“æœå¼¹çª—
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                document.getElementById('result-modal').style.display = 'none';
            });
            
            // å…³é—­è§‰é†’å¼¹çª—
            document.getElementById('awakening-confirm-btn').addEventListener('click', () => {
                document.getElementById('awakening-modal').style.display = 'none';
            });
            
            // å…³é—­æ‰€æœ‰å¼¹çª—çš„å…³é—­æŒ‰é’®
            document.querySelectorAll('.modal-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', () => {
                    closeBtn.closest('.modal').style.display = 'none';
                });
            });
            
            // è£…å¤‡æ§½ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.slot').forEach(slot => {
            slot.addEventListener('click', (e) => {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯â€œè„±ä¸‹â€æŒ‰é’®
                if (e.target && e.target.classList.contains('btn-remove-equipment')) {
                    return; // ä¸æ‰§è¡Œæ‰“å¼€è£…å¤‡é€‰æ‹©å¼¹çª—çš„æ“ä½œ
                }
                
                const slotId = slot.dataset.slot;
                showEquipmentSelectionModal(slotId);
            });
        });
            
            // è£…å¤‡é€‰æ‹©å¼¹çª—å…³é—­æŒ‰é’®
            document.getElementById('equipment-selection-close').addEventListener('click', () => {
                document.getElementById('equipment-selection-modal').style.display = 'none';
            });
            
            // è£…å¤‡é€‰æ‹©å¼¹çª—å–æ¶ˆæŒ‰é’®
            document.getElementById('equipment-selection-cancel').addEventListener('click', () => {
                document.getElementById('equipment-selection-modal').style.display = 'none';
            });
        }

        // æ˜¾ç¤ºç»“æœå¼¹çª—
        function showResultModal(message, type) {
            document.getElementById('modal-body').innerHTML = message;
            document.getElementById('result-modal').style.display = 'flex';
            
            // æ ¹æ®ç±»å‹è®¾ç½®æŒ‰é’®é¢œè‰²
            const buttons = document.querySelectorAll('#result-modal .btn');
            buttons.forEach(btn => {
                btn.className = `btn btn-${type}`;
            });
        }

        // æ˜¾ç¤ºè§‰é†’å¼¹çª—
        function showAwakeningModal() {
            document.getElementById('awakening-modal').style.display = 'flex';
            
            // è§‰é†’å¤„ç†
            gameData.character.awakeningLevel++;
            gameData.character.level = 1;
            gameData.character.exp = 0;
            gameData.character.maxExp = 100;
            
            // æ›´æ–°æœ€å¤§ç»éªŒ
            gameData.character.maxExp = gameData.character.level * gameData.character.level * 100;
            
            // æ›´æ–°å±æ€§
            updateDerivedStats();
            
            // æ›´æ–°UI
            updateUI();
        }

        // æ˜¾ç¤ºæˆ˜æ–—ä¸­æ“ä½œæç¤ºå¼¹çª—
        function showBattleOperationModal() {
            elements.battleOperationModal.style.display = 'flex';
        }

        // æ˜¾ç¤ºè£…å¤‡é€‰æ‹©å¼¹çª—
        function showEquipmentSelectionModal(slotId) {
            // æ¸…ç©ºè£…å¤‡é€‰æ‹©ç½‘æ ¼
            elements.equipmentSelectionGrid.innerHTML = '';
            
            // ç­›é€‰èƒŒåŒ…ä¸­å¯¹åº”éƒ¨ä½çš„è£…å¤‡
            const slotEquipment = gameData.equipment.inventory.filter(equipment => {
                return equipment.slot === slotId && !equipment.equipped;
            });
            
            // å¦‚æœæ²¡æœ‰å¯ç”¨è£…å¤‡ï¼Œæ˜¾ç¤ºæç¤º
            if (slotEquipment.length === 0) {
                const noEquipmentElement = document.createElement('div');
                noEquipmentElement.className = 'stat-item';
                noEquipmentElement.innerHTML = `<div>æ²¡æœ‰å¯ç”¨çš„${equipmentSlots[slotId]}è£…å¤‡</div>`;
                elements.equipmentSelectionGrid.appendChild(noEquipmentElement);
            } else {
                // æ·»åŠ è£…å¤‡åˆ°é€‰æ‹©ç½‘æ ¼
                slotEquipment.forEach(equipment => {
                    const equipmentElement = document.createElement('div');
                    equipmentElement.className = `equipment-item ${equipment.locked ? 'locked' : ''}`;
                    equipmentElement.dataset.id = equipment.id;
                    
                    equipmentElement.innerHTML = `
                        <div class="equipment-name">
                            <span class="quality quality-${equipment.quality}">${equipmentQuality[equipment.quality].name}</span> ${equipment.name}
                            ${equipment.reinforce > 0 ? `+${equipment.reinforce}` : ''}
                            ${equipment.evolve > 0 ? `â˜…${equipment.evolve}` : ''}
                        </div>
                        <div class="equipment-info">
                            éƒ¨ä½: ${equipmentSlots[equipment.slot]} | ç­‰çº§: ${equipment.level}
                        </div>
                        <div class="equipment-attrs">
                            ${equipment.baseAttributes.map(attr => `<div class="equipment-attr">${attr}</div>`).join('')}
                            ${equipment.additionalAttributes.map(attr => `<div class="equipment-attr">${attr}</div>`).join('')}
                        </div>
                        <button class="btn btn-success" data-equip-id="${equipment.id}">ç©¿æˆ´</button>
                    `;
                    
                    elements.equipmentSelectionGrid.appendChild(equipmentElement);
                });
            }
            
            // è®¾ç½®å¼¹çª—æ ‡é¢˜
            document.querySelector('.equipment-selection-title').textContent = `é€‰æ‹©${equipmentSlots[slotId]}`;
            
            // æ˜¾ç¤ºå¼¹çª—
            elements.equipmentSelectionModal.style.display = 'flex';
            
            // æ·»åŠ è£…å¤‡é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('[data-equip-id]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const equipmentId = parseInt(btn.dataset.equipId);
                    const equipment = gameData.equipment.inventory.find(e => e.id === equipmentId);
                    
                    if (equipment) {
                        // æ£€æŸ¥è£…å¤‡ç­‰çº§æ˜¯å¦é«˜äºè§’è‰²ç­‰çº§
                        if (equipment.level > gameData.character.level) {
                            addBattleLog(`è£…å¤‡ç­‰çº§${equipment.level}é«˜äºä½ çš„è§’è‰²ç­‰çº§${gameData.character.level}ï¼Œæ— æ³•ç©¿æˆ´`);
                            return;
                        }
                        
                        // æ£€æŸ¥è¯¥éƒ¨ä½æ˜¯å¦å·²æœ‰è£…å¤‡
                        if (gameData.equipment.slots[slotId]) {
                            addBattleLog(`è¯¥éƒ¨ä½å·²æœ‰è£…å¤‡ï¼Œæ— æ³•ç©¿æˆ´`);
                            return;
                        }
                        
                        // ç©¿æˆ´æ–°è£…å¤‡
                        gameData.equipment.slots[slotId] = equipment;
                        equipment.equipped = true;
                        
                        // æ›´æ–°å±æ€§
                        updateDerivedStats();
                        
                        // å…³é—­å¼¹çª—
                        elements.equipmentSelectionModal.style.display = 'none';
                        
                        // æ›´æ–°UI
                        updateUI();
                        renderInventory();
                        
                        // è‡ªåŠ¨ä¿å­˜
                        saveGameData();
                    }
                });
            });
        }

        // æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
        function checkOfflineGains() {
            const now = Date.now();
            const offlineTime = (now - gameData.lastActivityTime) / 1000; // ç§’
            
            if (offlineTime > 0) {
                // è®¡ç®—ç¦»çº¿æˆ˜æ–—æ¬¡æ•°
                const battles = Math.floor(offlineTime / 10); // æ¯10ç§’ä¸€æ¬¡æˆ˜æ–—
                
                if (battles > 0) {
                    // è®¡ç®—ç¦»çº¿æ”¶ç›Š
                    gameData.offlineExp = Math.floor(0.5 * gameData.character.level * offlineTime / 60); // æ¯åˆ†é’Ÿ0.5*ç­‰çº§ç»éªŒ
                    gameData.offlineGold = Math.floor(1 * gameData.character.level * offlineTime / 60); // æ¯åˆ†é’Ÿ1*ç­‰çº§é‡‘å¸
                    
                    // æ›´æ–°è§’è‰²æ•°æ®
                    gameData.character.exp += gameData.offlineExp;
                    gameData.character.gold += gameData.offlineGold;
                    
                    // æ£€æŸ¥å‡çº§
                    while (gameData.character.exp >= gameData.character.maxExp && gameData.character.level < 200) {
                        gameData.character.level++;
                        gameData.character.exp -= gameData.character.maxExp;
                        gameData.character.maxExp = gameData.character.level * gameData.character.level * 100;
                        
                        // æ›´æ–°å±æ€§
                        updateDerivedStats();
                        
                        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°200çº§
                        if (gameData.character.level === 200) {
                            showAwakeningModal();
                        }
                    }
                    
                    // æ·»åŠ ç¦»çº¿æ”¶ç›Šæ—¥å¿—
                    addBattleLog(`ç¦»çº¿æ”¶ç›Šï¼šè·å¾—${battles}æ¬¡æˆ˜æ–—ç»éªŒï¼Œ${gameData.offlineExp}ç»éªŒï¼Œ${gameData.offlineGold}é‡‘å¸`);
                    
                    // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
                    gameData.lastActivityTime = now;
                    
                    // ä¿å­˜æ•°æ®
                    saveGameData();
                    
                    // æ›´æ–°UI
                    updateUI();
                }
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', initGame);
    </script>
<!--å®¢æœ å¼€å§‹-->
<script src="//g8hh.github.io/static/js/jquery.min.js"></script>
<link rel="stylesheet" href="//g8hh.github.io/static/css/kf.css" type="text/css" media="screen" charset="utf-8">
<script src="//g8hh.github.io/static/js/kf.js"></script>
<!-- å®¢æœ ç»“æŸ -->
<!--ç«™é•¿ç»Ÿè®¡--> 
<div style="display: none">
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?028b1b5f659ed138230f4cafd7ad0dfc";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    </div>
</body>
</html>